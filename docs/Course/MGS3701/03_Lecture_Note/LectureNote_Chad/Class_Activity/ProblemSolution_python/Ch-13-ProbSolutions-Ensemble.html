<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Chapter 13: Combining Methods: Ensembles and Uplift Modeling – Chad’s Course Portfolio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../../">
<script src="../../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../../site_libs/bootstrap/bootstrap-6bd9cfa162949bde0a231f530c97869d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../../index.html">
    <span class="navbar-title">Chad’s Course Portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-ge2021-reserach-technology" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">GE2021: Reserach Technology</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-ge2021-reserach-technology">    
        <li>
    <a class="dropdown-item" href="../../../../../../Course/GE2021/03_Lecture_Note/LectureNote_Chad/PPT/chapter0/chapter0.html">
 <span class="dropdown-text">Course Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../../Course/GE2021/03_Lecture_Note/LectureNote_Chad/PPT/chapter1/chapter1.html">
 <span class="dropdown-text">Chapter1 Slide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../../Course/GE2021/03_Lecture_Note/LectureNote_Chad/PPT/chapter2/chapter2.html">
 <span class="dropdown-text">Chapter2 Slide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../../Course/GE2021/03_Lecture_Note/LectureNote_Chad/PPT/chapter3/chapter3.html">
 <span class="dropdown-text">Chapter3 Slide</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-mgs3001-python-for-business" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">MGS3001: Python for Business</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-mgs3001-python-for-business">    
        <li>
    <a class="dropdown-item" href="../../../../../../Course/MGS3001/03_Lecture_Note/LectureNote_Chad/PPT/chapter0/chapter0.html">
 <span class="dropdown-text">Course Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../../Course/MGS3001/03_Lecture_Note/LectureNote_Chad/PPT/chapter1/chapter1.html">
 <span class="dropdown-text">Chapter1 Slide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../../Course/MGS3001/03_Lecture_Note/LectureNote_Chad/PPT/chapter2/chapter2.html">
 <span class="dropdown-text">Chapter2 Slide</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-mgs3701-data-mining" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">MGS3701: Data Mining</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-mgs3701-data-mining">    
        <li>
    <a class="dropdown-item" href="../../../../../../Course/MGS3701/03_Lecture_Note/LectureNote_Chad/PPT/chapter0/chapter0.html">
 <span class="dropdown-text">Course Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../../Course/MGS3701/03_Lecture_Note/LectureNote_Chad/PPT/chapter1/chapter1.html">
 <span class="dropdown-text">Chapter1 Slide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../../Course/MGS3701/03_Lecture_Note/LectureNote_Chad/Lecture_Note/chapter1/chapter1_note.html">
 <span class="dropdown-text">Chapter1 Lecture Note</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../../Course/MGS3701/03_Lecture_Note/LectureNote_Chad/PPT/chapter2/chapter2.html">
 <span class="dropdown-text">Chapter2 Slide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../../Course/MGS3701/03_Lecture_Note/LectureNote_Chad/Lecture_Note/chapter2/chapter2_note.qmd">
 <span class="dropdown-text">Chapter2 Lecture Note</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../../Course/MGS3701/03_Lecture_Note/LectureNote_Chad/Class_Activity/ProblemSolution_python/Ch-02-ProbSolutions-Overview.html">
 <span class="dropdown-text">Chapter2 Problem and Solution [Python]</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#problem-13.1-acceptance-of-consumer-loan" id="toc-problem-13.1-acceptance-of-consumer-loan" class="nav-link active" data-scroll-target="#problem-13.1-acceptance-of-consumer-loan">Problem 13.1: Acceptance of Consumer Loan</a>
  <ul class="collapse">
  <li><a href="#data-preprocessing" id="toc-data-preprocessing" class="nav-link" data-scroll-target="#data-preprocessing">Data preprocessing</a></li>
  <li><a href="#solution-13.1.a" id="toc-solution-13.1.a" class="nav-link" data-scroll-target="#solution-13.1.a">Solution 13.1.a</a></li>
  <li><a href="#solution-13.1.b" id="toc-solution-13.1.b" class="nav-link" data-scroll-target="#solution-13.1.b">Solution 13.1.b</a></li>
  <li><a href="#solution-13.1.c" id="toc-solution-13.1.c" class="nav-link" data-scroll-target="#solution-13.1.c">Solution 13.1.c</a></li>
  <li><a href="#solution-13.1.d" id="toc-solution-13.1.d" class="nav-link" data-scroll-target="#solution-13.1.d">Solution 13.1.d</a></li>
  </ul></li>
  <li><a href="#problem-13.2-ebay-auctions---boosting-and-bagging" id="toc-problem-13.2-ebay-auctions---boosting-and-bagging" class="nav-link" data-scroll-target="#problem-13.2-ebay-auctions---boosting-and-bagging">Problem 13.2: eBay Auctions - Boosting and Bagging</a>
  <ul class="collapse">
  <li><a href="#solution-13.2.a" id="toc-solution-13.2.a" class="nav-link" data-scroll-target="#solution-13.2.a">Solution 13.2.a</a></li>
  <li><a href="#solution-13.2.b" id="toc-solution-13.2.b" class="nav-link" data-scroll-target="#solution-13.2.b">Solution 13.2.b</a></li>
  <li><a href="#solution-13.2.c" id="toc-solution-13.2.c" class="nav-link" data-scroll-target="#solution-13.2.c">Solution 13.2.c</a></li>
  <li><a href="#solution-13.2.d" id="toc-solution-13.2.d" class="nav-link" data-scroll-target="#solution-13.2.d">Solution 13.2.d</a></li>
  </ul></li>
  <li><a href="#problem-13.3---predicting-delayed-flights-boosting" id="toc-problem-13.3---predicting-delayed-flights-boosting" class="nav-link" data-scroll-target="#problem-13.3---predicting-delayed-flights-boosting">Problem 13.3 - Predicting Delayed Flights (Boosting)</a>
  <ul class="collapse">
  <li><a href="#data-preprocessing-1" id="toc-data-preprocessing-1" class="nav-link" data-scroll-target="#data-preprocessing-1">Data Preprocessing</a></li>
  <li><a href="#solution-13.3.a" id="toc-solution-13.3.a" class="nav-link" data-scroll-target="#solution-13.3.a">Solution 13.3.a</a></li>
  <li><a href="#solution-13.3.b" id="toc-solution-13.3.b" class="nav-link" data-scroll-target="#solution-13.3.b">Solution 13.3.b</a></li>
  <li><a href="#solution-13.3.c" id="toc-solution-13.3.c" class="nav-link" data-scroll-target="#solution-13.3.c">Solution 13.3.c</a></li>
  <li><a href="#additional-material-13.3" id="toc-additional-material-13.3" class="nav-link" data-scroll-target="#additional-material-13.3">Additional material 13.3</a></li>
  </ul></li>
  <li><a href="#problem-13.4---hair-care-product---uplift-modeling" id="toc-problem-13.4---hair-care-product---uplift-modeling" class="nav-link" data-scroll-target="#problem-13.4---hair-care-product---uplift-modeling">Problem 13.4 - Hair Care Product - Uplift Modeling</a>
  <ul class="collapse">
  <li><a href="#solution-13.4.a" id="toc-solution-13.4.a" class="nav-link" data-scroll-target="#solution-13.4.a">Solution 13.4.a</a>
  <ul class="collapse">
  <li><a href="#a.ii" id="toc-a.ii" class="nav-link" data-scroll-target="#a.ii">13.4.a.ii</a></li>
  </ul></li>
  <li><a href="#solution-13.4.b" id="toc-solution-13.4.b" class="nav-link" data-scroll-target="#solution-13.4.b">Solution 13.4.b</a>
  <ul class="collapse">
  <li><a href="#solution-13.4.b.i" id="toc-solution-13.4.b.i" class="nav-link" data-scroll-target="#solution-13.4.b.i">Solution 13.4.b.i</a></li>
  <li><a href="#solution-13.4.b.ii" id="toc-solution-13.4.b.ii" class="nav-link" data-scroll-target="#solution-13.4.b.ii">Solution 13.4.b.ii</a></li>
  </ul></li>
  <li><a href="#solution-13.4.c" id="toc-solution-13.4.c" class="nav-link" data-scroll-target="#solution-13.4.c">Solution 13.4.c</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Chapter 13: Combining Methods: Ensembles and Uplift Modeling</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<ol start="3" type="a">
<li>2019-2020 Galit Shmueli, Peter C. Bruce, Peter Gedeck</li>
</ol>
<p><em>Data Mining for Business Analytics: Concepts, Techniques, and Applications in Python</em> (First Edition) Galit Shmueli, Peter C. Bruce, Peter Gedeck, and Nitin R. Patel. 2019.</p>
<p>Date: 2020-03-08</p>
<p>Python Version: 3.8.2 Jupyter Notebook Version: 5.6.1</p>
<p>Packages: - dmba: 0.0.12 - matplotlib: 3.2.0 - pandas: 1.0.1 - scikit-learn: 0.22.2</p>
<p>The assistance from Mr.&nbsp;Kuber Deokar and Ms.&nbsp;Anuja Kulkarni in preparing these solutions is gratefully acknowledged.</p>
</blockquote>
<div id="cell-3" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import required packages for this chapter</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> preprocessing</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeClassifier</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.naive_bayes <span class="im">import</span> MultinomialNB</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> AdaBoostClassifier</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> BaggingClassifier</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> KNeighborsClassifier</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split, GridSearchCV</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pylab <span class="im">as</span> plt</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dmba <span class="im">import</span> classificationSummary</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dmba <span class="im">import</span> liftChart</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-4" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Working directory:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We assume that data are kept in the same directory as the notebook. If you keep your </span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># data in a different folder, replace the argument of the `Path`</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>DATA <span class="op">=</span> Path(<span class="st">'.'</span>).resolve().parent <span class="op">/</span> <span class="st">'data'</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>FIGURES <span class="op">=</span> Path(<span class="st">'.'</span>).resolve().parent <span class="op">/</span> <span class="st">'figures'</span> <span class="op">/</span> <span class="st">'chapter_13'</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>FIGURES.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>, parents<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># and then load data using </span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># pd.read_csv(DATA / ‘filename.csv’)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="problem-13.1-acceptance-of-consumer-loan" class="level1">
<h1>Problem 13.1: Acceptance of Consumer Loan</h1>
<p>Universal Bank has begun a program to encourage its existing customers to borrow via a consumer loan program. The bank has promoted the loan to 5000 customers, of whom 480 accepted the offer. The data are available in file <strong>UniversalBank.csv</strong>. The bank now wants to develop a model to predict which customers have the greatest probability of accepting the loan, to reduce promotion costs and send the offer only to a subset of its customers.</p>
<p>We will develop several models, then combine them in an ensemble. The models we will use are 1. logistic regression, 2. <span class="math inline">\(k\)</span>-nearest neighbors with <span class="math inline">\(k=3\)</span>, and 3. classification trees</p>
<section id="data-preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="data-preprocessing">Data preprocessing</h2>
<p>Preprocess the data as follows:</p>
<ul>
<li>Bin the following variables so they can be used in Naive Bayes: Age (5 bins), Experience (10 bins), Income (5 bins), CC Average (6 bins), and Mortgage (10 bins).</li>
<li>Education and Family can be used as is, without binning.</li>
<li>Zip code can be ignored.</li>
<li>Use one-hot-encoding to convert the categorical data into indicator variables</li>
<li>Partition the data: 60% training, 40% validation.</li>
</ul>
<div id="cell-6" class="cell" data-scrolled="true" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>bank_df <span class="op">=</span> pd.read_csv(DATA <span class="op">/</span> <span class="st">'UniversalBank.csv'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>bank_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ID</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Experience</th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">ZIP Code</th>
<th data-quarto-table-cell-role="th">Family</th>
<th data-quarto-table-cell-role="th">CCAvg</th>
<th data-quarto-table-cell-role="th">Education</th>
<th data-quarto-table-cell-role="th">Mortgage</th>
<th data-quarto-table-cell-role="th">Personal Loan</th>
<th data-quarto-table-cell-role="th">Securities Account</th>
<th data-quarto-table-cell-role="th">CD Account</th>
<th data-quarto-table-cell-role="th">Online</th>
<th data-quarto-table-cell-role="th">CreditCard</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>25</td>
<td>1</td>
<td>49</td>
<td>91107</td>
<td>4</td>
<td>1.6</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>45</td>
<td>19</td>
<td>34</td>
<td>90089</td>
<td>3</td>
<td>1.5</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>39</td>
<td>15</td>
<td>11</td>
<td>94720</td>
<td>1</td>
<td>1.0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>35</td>
<td>9</td>
<td>100</td>
<td>94112</td>
<td>1</td>
<td>2.7</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>35</td>
<td>8</td>
<td>45</td>
<td>91330</td>
<td>4</td>
<td>1.0</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop ID and zip code columns</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>bank_df.drop(columns<span class="op">=</span>[<span class="st">'ID'</span>, <span class="st">'ZIP Code'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The remaining columns (Age, Experience, Income, Mortgage and CCAvg) will be binned</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>bank_df[<span class="st">'Age'</span>] <span class="op">=</span> pd.cut(bank_df[<span class="st">'Age'</span>], <span class="dv">5</span>, labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>)).astype(<span class="st">'category'</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>bank_df[<span class="st">'Experience'</span>] <span class="op">=</span> pd.cut(bank_df[<span class="st">'Experience'</span>], <span class="dv">10</span>, labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)).astype(<span class="st">'category'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>bank_df[<span class="st">'Income'</span>] <span class="op">=</span> pd.cut(bank_df[<span class="st">'Income'</span>], <span class="dv">5</span>, labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>)).astype(<span class="st">'category'</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>bank_df[<span class="st">'CCAvg'</span>] <span class="op">=</span> pd.cut(bank_df[<span class="st">'CCAvg'</span>], <span class="dv">6</span>, labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">7</span>)).astype(<span class="st">'category'</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>bank_df[<span class="st">'Mortgage'</span>] <span class="op">=</span> pd.cut(bank_df[<span class="st">'Mortgage'</span>], <span class="dv">10</span>, labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)).astype(<span class="st">'category'</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Use one-hot-encoding for the </span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> bank_df.drop(columns<span class="op">=</span>[<span class="st">'Personal Loan'</span>])</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> pd.get_dummies(X)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> bank_df[<span class="st">'Personal Loan'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-8" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>train_X, valid_X, train_y, valid_y <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.4</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Training set:'</span>, train_X.shape, <span class="st">'Validation set:'</span>, valid_X.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training set: (3000, 42) Validation set: (2000, 42)</code></pre>
</div>
</div>
</section>
<section id="solution-13.1.a" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.1.a">Solution 13.1.a</h2>
<p>Fit models to the data for 1. logistic regression, 2. <span class="math inline">\(k\)</span>-nearest neighbors with <span class="math inline">\(k=3\)</span>, 3. classification trees, and 4. Naive Bayes.</p>
<p>Use Personal Loan as the outcome variable. Report the validation confusion matrix for each of the models.</p>
<div id="cell-10" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Logistic regression</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>logit_reg <span class="op">=</span> LogisticRegression(penalty<span class="op">=</span><span class="st">"l2"</span>, C<span class="op">=</span><span class="fl">1e42</span>, solver<span class="op">=</span><span class="st">'liblinear'</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>logit_reg.fit(train_X, train_y)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, logit_reg.predict(valid_X))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># k-nearest neighbors</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>knn <span class="op">=</span> KNeighborsClassifier(n_neighbors<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>knn.fit(train_X, train_y)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, knn.predict(valid_X))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (Accuracy 0.9490)

       Prediction
Actual    0    1
     0 1773   34
     1   68  125
Confusion Matrix (Accuracy 0.9360)

       Prediction
Actual    0    1
     0 1798    9
     1  119   74</code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># classification tree</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># user grid search to find optimized tree</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_depth'</span>: [<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">25</span>], </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'min_impurity_decrease'</span>: [<span class="dv">0</span>, <span class="fl">0.001</span>, <span class="fl">0.005</span>, <span class="fl">0.01</span>], </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'min_samples_split'</span>: [<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>], </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>gridSearch <span class="op">=</span> GridSearchCV(DecisionTreeClassifier(random_state<span class="op">=</span><span class="dv">1</span>), param_grid, cv<span class="op">=</span><span class="dv">5</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>gridSearch.fit(train_X, train_y)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Initial parameters: '</span>, gridSearch.best_params_)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_depth'</span>: [<span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>], </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'min_impurity_decrease'</span>: [<span class="dv">0</span>, <span class="fl">0.0005</span>, <span class="fl">0.001</span>, <span class="fl">0.0015</span>], </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'min_samples_split'</span>: [<span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>, <span class="dv">15</span>], </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>gridSearch <span class="op">=</span> GridSearchCV(DecisionTreeClassifier(random_state<span class="op">=</span><span class="dv">1</span>), param_grid, cv<span class="op">=</span><span class="dv">5</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>gridSearch.fit(train_X, train_y)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Improved parameters: '</span>, gridSearch.best_params_)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>classTree <span class="op">=</span> gridSearch.best_estimator_</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, classTree.predict(valid_X))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial parameters:  {'max_depth': 10, 'min_impurity_decrease': 0.001, 'min_samples_split': 10}
Improved parameters:  {'max_depth': 7, 'min_impurity_decrease': 0, 'min_samples_split': 15}
Confusion Matrix (Accuracy 0.9670)

       Prediction
Actual    0    1
     0 1789   18
     1   48  145</code></pre>
</div>
</div>
<div id="cell-12" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Naive-Bayes</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>nb <span class="op">=</span> MultinomialNB(alpha<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>nb.fit(train_X, train_y)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, nb.predict(valid_X))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (Accuracy 0.8860)

       Prediction
Actual    0    1
     0 1657  150
     1   78  115</code></pre>
</div>
</div>
</section>
<section id="solution-13.1.b" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.1.b">Solution 13.1.b</h2>
<p>Create a data frame with the actual outcome, predicted outcome, and each of the models. Report the first 10 rows of this data frame.</p>
<div id="cell-14" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> pd.DataFrame({</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'actual'</span>: valid_y,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Logistic regression'</span>: logit_reg.predict(valid_X),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'k-nearest neighbor'</span>: knn.predict(valid_X),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'classification tree'</span>: classTree.predict(valid_X),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'naive-bayes'</span>: nb.predict(valid_X),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>result.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">actual</th>
<th data-quarto-table-cell-role="th">Logistic regression</th>
<th data-quarto-table-cell-role="th">k-nearest neighbor</th>
<th data-quarto-table-cell-role="th">classification tree</th>
<th data-quarto-table-cell-role="th">naive-bayes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2764</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4767</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3814</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3499</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2735</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3922</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2701</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1179</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">932</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">792</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="solution-13.1.c" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.1.c">Solution 13.1.c</h2>
<p>Add two columns to this data frame for (1) a majority vote of predicted outcomes, and (2) the average of the predicted probabilities. Using the classifications generated by these two methods derive a confusion matrix for each method and report the overall accuracy.</p>
<div id="cell-16" class="cell" data-scrolled="false" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># (1) majority vote</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>predColumns <span class="op">=</span> [<span class="st">'Logistic regression'</span>, <span class="st">'k-nearest neighbor'</span>, <span class="st">'classification tree'</span>, <span class="st">'naive-bayes'</span>]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>result[<span class="st">'majority'</span>] <span class="op">=</span> [<span class="dv">1</span> <span class="cf">if</span> p <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="dv">0</span> <span class="cf">for</span> p <span class="kw">in</span> result[predColumns].mean(axis<span class="op">=</span><span class="dv">1</span>)]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># (2) average probability</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># first create a data frame with the predicted probabilities for Personal Loan of 1</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>probabilities <span class="op">=</span> pd.DataFrame({</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'actual'</span>: valid_y,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Logistic regression'</span>: logit_reg.predict_proba(valid_X)[:, <span class="dv">1</span>],</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'k-nearest neighbor'</span>: knn.predict_proba(valid_X)[:, <span class="dv">1</span>],</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'classification tree'</span>: classTree.predict_proba(valid_X)[:, <span class="dv">1</span>],</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'naive-bayes'</span>: nb.predict_proba(valid_X)[:, <span class="dv">1</span>],</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>result[<span class="st">'average'</span>] <span class="op">=</span> probabilities[predColumns].mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>result[<span class="st">'average_pred'</span>] <span class="op">=</span> [<span class="dv">1</span> <span class="cf">if</span> p <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="dv">0</span> <span class="cf">for</span> p <span class="kw">in</span> result[<span class="st">'average'</span>]]</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>result.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">actual</th>
<th data-quarto-table-cell-role="th">Logistic regression</th>
<th data-quarto-table-cell-role="th">k-nearest neighbor</th>
<th data-quarto-table-cell-role="th">classification tree</th>
<th data-quarto-table-cell-role="th">naive-bayes</th>
<th data-quarto-table-cell-role="th">majority</th>
<th data-quarto-table-cell-role="th">average</th>
<th data-quarto-table-cell-role="th">average_pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2764</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1.572781e-03</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4767</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>2.846366e-07</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3814</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>6.143648e-07</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3499</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>3.452705e-02</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2735</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>3.897706e-03</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3922</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1.440022e-06</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2701</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>8.749563e-04</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1179</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1.418331e-01</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">932</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>5.011567e-01</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">792</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>6.453092e-01</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-17" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Majority vote'</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>classificationSummary(result[<span class="st">'actual'</span>], result[<span class="st">'majority'</span>])</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Average probability'</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>classificationSummary(result[<span class="st">'actual'</span>], result[<span class="st">'average_pred'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Majority vote
Confusion Matrix (Accuracy 0.9495)

       Prediction
Actual    0    1
     0 1797   10
     1   91  102
Average probability
Confusion Matrix (Accuracy 0.9595)

       Prediction
Actual    0    1
     0 1796   11
     1   70  123</code></pre>
</div>
</div>
</section>
<section id="solution-13.1.d" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.1.d">Solution 13.1.d</h2>
<p>Compare the error rates for the four individual methods and the two ensemble methods.</p>
<div id="cell-19" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [<span class="st">'Logistic regression'</span>, <span class="st">'k-nearest neighbor'</span>, <span class="st">'classification tree'</span>, <span class="st">'naive-bayes'</span>, </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>          <span class="st">'majority'</span>, <span class="st">'average_pred'</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>errorRates <span class="op">=</span> []</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model <span class="kw">in</span> models:</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    errorRates.append({<span class="st">'model'</span>: model, <span class="st">'error rate'</span>: accuracy_score(result[<span class="st">'actual'</span>], result[model])})</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(errorRates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">error rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Logistic regression</td>
<td>0.9490</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>k-nearest neighbor</td>
<td>0.9360</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>classification tree</td>
<td>0.9670</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>naive-bayes</td>
<td>0.8860</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>majority</td>
<td>0.9495</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>average_pred</td>
<td>0.9595</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The accuracy values show that the decision tree model outperforms the other three methods. The two ensemble models have slightly lower performance compared to the classification tree.</p>
</section>
</section>
<section id="problem-13.2-ebay-auctions---boosting-and-bagging" class="level1">
<h1>Problem 13.2: eBay Auctions - Boosting and Bagging</h1>
<p>Using the eBay auction data (file <em>eBayAuctions.csv</em>) with variable Competitive as the outcome variable, partition the data into training (60%) and validation (40%).</p>
<div id="cell-22" class="cell" data-scrolled="true" data-execution_count="13">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ebay_df <span class="op">=</span> pd.read_csv(DATA <span class="op">/</span> <span class="st">'eBayAuctions.csv'</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ebay_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Category</th>
<th data-quarto-table-cell-role="th">currency</th>
<th data-quarto-table-cell-role="th">sellerRating</th>
<th data-quarto-table-cell-role="th">Duration</th>
<th data-quarto-table-cell-role="th">endDay</th>
<th data-quarto-table-cell-role="th">ClosePrice</th>
<th data-quarto-table-cell-role="th">OpenPrice</th>
<th data-quarto-table-cell-role="th">Competitive?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Music/Movie/Game</td>
<td>US</td>
<td>3249</td>
<td>5</td>
<td>Mon</td>
<td>0.01</td>
<td>0.01</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Music/Movie/Game</td>
<td>US</td>
<td>3249</td>
<td>5</td>
<td>Mon</td>
<td>0.01</td>
<td>0.01</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Music/Movie/Game</td>
<td>US</td>
<td>3249</td>
<td>5</td>
<td>Mon</td>
<td>0.01</td>
<td>0.01</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Music/Movie/Game</td>
<td>US</td>
<td>3249</td>
<td>5</td>
<td>Mon</td>
<td>0.01</td>
<td>0.01</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Music/Movie/Game</td>
<td>US</td>
<td>3249</td>
<td>5</td>
<td>Mon</td>
<td>0.01</td>
<td>0.01</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-23" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert categorical variables into indicator and drop the first column of each of them</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>ebay_df <span class="op">=</span> pd.get_dummies(ebay_df, prefix_sep<span class="op">=</span><span class="st">'_'</span>, drop_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> ebay_df[<span class="st">'Competitive?'</span>]</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> ebay_df.drop(columns<span class="op">=</span>[<span class="st">'Competitive?'</span>])</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># partition data</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>train_X, valid_X, train_y, valid_y <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.4</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="solution-13.2.a" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.2.a">Solution 13.2.a</h2>
<p>Run a classification tree, using the default settings of <code>DecisionTreeClassifier</code>. Looking at the validation set, what is the overall accuracy? What is the lift on the first decile?</p>
<div id="cell-25" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>classTree <span class="op">=</span> DecisionTreeClassifier(random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>classTree.fit(train_X, train_y)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, classTree.predict(valid_X))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (Accuracy 0.8758)

       Prediction
Actual   0   1
     0 315  38
     1  60 376</code></pre>
</div>
</div>
<div id="cell-26" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the information for the lift chart</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>proba <span class="op">=</span> classTree.predict_proba(valid_X)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> pd.DataFrame({<span class="st">'actual'</span>: valid_y, </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'p(0)'</span>: [p[<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> proba],</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'p(1)'</span>: [p[<span class="dv">1</span>] <span class="cf">for</span> p <span class="kw">in</span> proba],</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'predicted'</span>: classTree.predict(valid_X) })</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> result.sort_values(by<span class="op">=</span>[<span class="st">'p(1)'</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>liftChart(df[<span class="st">'p(1)'</span>], title<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch-13-ProbSolutions-Ensemble_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="solution-13.2.b" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.2.b">Solution 13.2.b</h2>
<p>Run a boosted tree with the same predictors (use <code>AdaBoostClassifier</code> with <code>DecisionTreeClassifier</code> as the base estimator). For the validation set, what is the overall accuracy? What is the lift on the first decile?</p>
<div id="cell-28" class="cell" data-scrolled="true" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>boost <span class="op">=</span> AdaBoostClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, base_estimator<span class="op">=</span>classTree, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>boost.fit(train_X, train_y)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, boost.predict(valid_X))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (Accuracy 0.8619)

       Prediction
Actual   0   1
     0 312  41
     1  68 368</code></pre>
</div>
</div>
<div id="cell-29" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the information for the lift chart</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>proba <span class="op">=</span> boost.predict_proba(valid_X)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> pd.DataFrame({<span class="st">'actual'</span>: valid_y, </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'p(0)'</span>: [p[<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> proba],</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'p(1)'</span>: [p[<span class="dv">1</span>] <span class="cf">for</span> p <span class="kw">in</span> proba],</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'predicted'</span>: boost.predict(valid_X) })</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> result.sort_values(by<span class="op">=</span>[<span class="st">'p(1)'</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>liftChart(df[<span class="st">'p(1)'</span>], title<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch-13-ProbSolutions-Ensemble_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="solution-13.2.c" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.2.c">Solution 13.2.c</h2>
<p>Run a bagged tree with the same predictors (use <code>BaggingClassifier</code>). For the validation set, what is the overall accuracy? What is the lift on the first decile?</p>
<div id="cell-31" class="cell" data-scrolled="true" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>bagging <span class="op">=</span> BaggingClassifier(classTree, max_samples<span class="op">=</span><span class="fl">0.5</span>, max_features<span class="op">=</span><span class="fl">0.5</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>bagging.fit(train_X, train_y)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, bagging.predict(valid_X))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (Accuracy 0.8074)

       Prediction
Actual   0   1
     0 278  75
     1  77 359</code></pre>
</div>
</div>
<div id="cell-32" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the information for the lift chart</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>proba <span class="op">=</span> bagging.predict_proba(valid_X)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> pd.DataFrame({<span class="st">'actual'</span>: valid_y, </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'p(0)'</span>: [p[<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> proba],</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'p(1)'</span>: [p[<span class="dv">1</span>] <span class="cf">for</span> p <span class="kw">in</span> proba],</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'predicted'</span>: bagging.predict(valid_X) })</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> result.sort_values(by<span class="op">=</span>[<span class="st">'p(1)'</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>liftChart(df[<span class="st">'p(1)'</span>], title<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch-13-ProbSolutions-Ensemble_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="solution-13.2.d" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.2.d">Solution 13.2.d</h2>
<p>Run a random forest (use <code>RandomForestClassifier</code>). Compare the bagged tree to the random forest in terms of validation accuracy and lift on first decile. How are the two methods conceptually different?</p>
<div id="cell-34" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>rfModel <span class="op">=</span> RandomForestClassifier(random_state<span class="op">=</span><span class="dv">1</span>, n_estimators<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>rfModel.fit(train_X, train_y)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, rfModel.predict(valid_X))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (Accuracy 0.8644)

       Prediction
Actual   0   1
     0 320  33
     1  74 362</code></pre>
</div>
</div>
<div id="cell-35" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the information for the lift chart</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>proba <span class="op">=</span> rfModel.predict_proba(valid_X)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> pd.DataFrame({<span class="st">'actual'</span>: valid_y, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'p(0)'</span>: [p[<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> proba],</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'p(1)'</span>: [p[<span class="dv">1</span>] <span class="cf">for</span> p <span class="kw">in</span> proba],</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'predicted'</span>: rfModel.predict(valid_X) })</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> result.sort_values(by<span class="op">=</span>[<span class="st">'p(1)'</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>liftChart(df[<span class="st">'p(1)'</span>], title<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch-13-ProbSolutions-Ensemble_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="problem-13.3---predicting-delayed-flights-boosting" class="level1">
<h1>Problem 13.3 - Predicting Delayed Flights (Boosting)</h1>
<p>The file <em>FlightDelays.csv</em> contains information on all commercial flights departing the Washington, DC area and arriving at New York during January 2004. For each flight there is information on the departure and arrival airports, the distance of the route, the scheduled time and date of the flight, and so on. The variable that we are trying to predict is whether or not a flight is delayed. A delay is defined as an arrival that is at least 15 minutes later than scheduled.</p>
<section id="data-preprocessing-1" class="level2">
<h2 class="anchored" data-anchor-id="data-preprocessing-1">Data Preprocessing</h2>
<p>Transform variable day of week info a categorical variable. Bin the scheduled departure time into eight bins (in Python use function <code>pd.cut()</code> from the <em>pandas</em> package). Partition the data into training (60%) and validation (40%).</p>
<p>Run a boosted classification tree for delay. With the exception of setting and , use default setting for the DecisionTreeClassifier and the AdaBoostClassifier.</p>
<p>Compared with the single tree, how does the boosted tree behave in terms of overall accuracy? Compared with the single tree, how does the boosted tree behave in terms of accuracy in identifying delayed flights? Explain why this model might have the best performance over the other models you fit.</p>
<div id="cell-38" class="cell" data-scrolled="false" data-execution_count="23">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(DATA <span class="op">/</span> <span class="st">'FlightDelays.csv'</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data.drop(columns<span class="op">=</span>[<span class="st">'FL_DATE'</span>, <span class="st">'FL_NUM'</span>, <span class="st">'TAIL_NUM'</span>, <span class="st">'DEP_TIME'</span>, <span class="st">'DAY_OF_MONTH'</span>])</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># transform variables and create bins</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>data.DAY_WEEK <span class="op">=</span> data.DAY_WEEK.astype(<span class="st">'category'</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>data.CRS_DEP_TIME <span class="op">=</span> pd.cut(data.CRS_DEP_TIME, bins<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>data.DEST <span class="op">=</span> data.DEST.astype(<span class="st">'category'</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>data.ORIGIN <span class="op">=</span> data.ORIGIN.astype(<span class="st">'category'</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.get_dummies(data, drop_first<span class="op">=</span><span class="va">True</span>, columns<span class="op">=</span>[<span class="st">'DAY_WEEK'</span>, <span class="st">'CRS_DEP_TIME'</span>, <span class="st">'DEST'</span>, <span class="st">'ORIGIN'</span>, <span class="st">'CARRIER'</span>])</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">DISTANCE</th>
<th data-quarto-table-cell-role="th">Weather</th>
<th data-quarto-table-cell-role="th">Flight Status</th>
<th data-quarto-table-cell-role="th">DAY_WEEK_2</th>
<th data-quarto-table-cell-role="th">DAY_WEEK_3</th>
<th data-quarto-table-cell-role="th">DAY_WEEK_4</th>
<th data-quarto-table-cell-role="th">DAY_WEEK_5</th>
<th data-quarto-table-cell-role="th">DAY_WEEK_6</th>
<th data-quarto-table-cell-role="th">DAY_WEEK_7</th>
<th data-quarto-table-cell-role="th">CRS_DEP_TIME_(791.25, 982.5]</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">DEST_LGA</th>
<th data-quarto-table-cell-role="th">ORIGIN_DCA</th>
<th data-quarto-table-cell-role="th">ORIGIN_IAD</th>
<th data-quarto-table-cell-role="th">CARRIER_DH</th>
<th data-quarto-table-cell-role="th">CARRIER_DL</th>
<th data-quarto-table-cell-role="th">CARRIER_MQ</th>
<th data-quarto-table-cell-role="th">CARRIER_OH</th>
<th data-quarto-table-cell-role="th">CARRIER_RU</th>
<th data-quarto-table-cell-role="th">CARRIER_UA</th>
<th data-quarto-table-cell-role="th">CARRIER_US</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>184</td>
<td>0</td>
<td>ontime</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>213</td>
<td>0</td>
<td>ontime</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>229</td>
<td>0</td>
<td>ontime</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>229</td>
<td>0</td>
<td>ontime</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>229</td>
<td>0</td>
<td>ontime</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>5 rows × 27 columns</p>
</div>
</div>
</div>
<p>Partition the data into training (60%) and validation (40%).</p>
<div id="cell-40" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> data[<span class="st">'Flight Status'</span>]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> data.drop(columns<span class="op">=</span>[<span class="st">'Flight Status'</span>])</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># partition data</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>train_X, valid_X, train_y, valid_y <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.4</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Run a boosted classification tree for delay. With the exception of setting <code>n_estimators=500</code> and <code>random_state=1</code>, use default setting for the DecisionTreeClassifier and the AdaBoostClassifier.</p>
<div id="cell-42" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>defaultOptions <span class="op">=</span> {<span class="st">'random_state'</span>: <span class="dv">1</span>}</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>defaultTree <span class="op">=</span> DecisionTreeClassifier(<span class="op">**</span>defaultOptions)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>defaultTree.fit(train_X, train_y)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, defaultTree.predict(valid_X), class_names<span class="op">=</span>[<span class="st">'delayed'</span>, <span class="st">'ontime'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (Accuracy 0.7310)

        Prediction
 Actual delayed  ontime
delayed      62     105
 ontime     132     582</code></pre>
</div>
</div>
<div id="cell-43" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>boost <span class="op">=</span> AdaBoostClassifier(DecisionTreeClassifier(<span class="op">**</span>defaultOptions), random_state<span class="op">=</span><span class="dv">1</span>, n_estimators<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>boost.fit(train_X, train_y)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, boost.predict(valid_X), class_names<span class="op">=</span>[<span class="st">'delayed'</span>, <span class="st">'ontime'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (Accuracy 0.7401)

        Prediction
 Actual delayed  ontime
delayed      37     130
 ontime      99     615</code></pre>
</div>
</div>
</section>
<section id="solution-13.3.a" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.3.a">Solution 13.3.a</h2>
<p>Compared with the single tree, how does the boosted tree behave in terms of overall accuracy?</p>
<p>The accuracy of the single tree is 0.73 and it is slightly higher (0.74) for the boosted tree.</p>
</section>
<section id="solution-13.3.b" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.3.b">Solution 13.3.b</h2>
<p>Compared with the single tree, how does the boosted tree behave in terms of accuracy in identifying delayed flights?</p>
<div id="cell-47" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'single tree: '</span>, <span class="dv">62</span> <span class="op">/</span> (<span class="dv">62</span> <span class="op">+</span> <span class="dv">105</span>))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'boosted tree: '</span>, <span class="dv">37</span> <span class="op">/</span> (<span class="dv">37</span> <span class="op">+</span> <span class="dv">130</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>single tree:  0.3712574850299401
boosted tree:  0.2215568862275449</code></pre>
</div>
</div>
<p>The single tree predicts 37% of the delayed flights correct. The boosted tree only 22%.</p>
</section>
<section id="solution-13.3.c" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.3.c">Solution 13.3.c</h2>
<p>Explain why this model might have the best performance over the other models you fit.</p>
<p>Boosting is an iterative procedure that develops successive trees with different weights applied to the records in each iteration. It often yields superior performance over single trees or bagged trees by concentrating (via the weights) on the records which were misclassified in earlier iterations.</p>
<p>In our case, the overall accuracy of the single tree is practically identical to the boosted tree, however the accuracy in identifying delayed flights is higher.</p>
</section>
<section id="additional-material-13.3" class="level2">
<h2 class="anchored" data-anchor-id="additional-material-13.3">Additional material 13.3</h2>
<p>In the above solution, we didn’t control the complexity of the model. We can use the arguments <code>max_depth</code> and <code>min_samples_split</code> to limit the size of the trees.</p>
<div id="cell-52" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>defaultOptions <span class="op">=</span> {<span class="st">'random_state'</span>: <span class="dv">1</span>, <span class="st">'max_depth'</span>: <span class="dv">6</span>, <span class="st">'min_samples_split'</span>: <span class="dv">3</span>, }</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>defaultTree <span class="op">=</span> DecisionTreeClassifier(<span class="op">**</span>defaultOptions)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>defaultTree.fit(train_X, train_y)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, defaultTree.predict(valid_X), class_names<span class="op">=</span>[<span class="st">'delayed'</span>, <span class="st">'ontime'</span>])</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>boost <span class="op">=</span> AdaBoostClassifier(DecisionTreeClassifier(<span class="op">**</span>defaultOptions), random_state<span class="op">=</span><span class="dv">1</span>, n_estimators<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>boost.fit(train_X, train_y)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid_y, boost.predict(valid_X), class_names<span class="op">=</span>[<span class="st">'delayed'</span>, <span class="st">'ontime'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (Accuracy 0.8229)

        Prediction
 Actual delayed  ontime
delayed      33     134
 ontime      22     692
Confusion Matrix (Accuracy 0.7514)

        Prediction
 Actual delayed  ontime
delayed      39     128
 ontime      91     623</code></pre>
</div>
</div>
<div id="cell-53" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'single tree: '</span>, <span class="dv">33</span> <span class="op">/</span> (<span class="dv">33</span> <span class="op">+</span> <span class="dv">134</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'boosted tree: '</span>, <span class="dv">39</span> <span class="op">/</span> (<span class="dv">39</span> <span class="op">+</span> <span class="dv">128</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>single tree:  0.19760479041916168
boosted tree:  0.23353293413173654</code></pre>
</div>
</div>
<p>The overall accuracy of the single tree is now 0.83 while it is practically unchanged for the boosted trees (0.75). The accuracy for predicting delayed flights on the other hand drops significantly for the single tree (20%), while it improves slightly for the boosted tree (23%).</p>
</section>
</section>
<section id="problem-13.4---hair-care-product---uplift-modeling" class="level1">
<h1>Problem 13.4 - Hair Care Product - Uplift Modeling</h1>
<p>This problem uses the data set in <em>Hair-Care-Product.csv</em>, courtesy of SAS. In this hypothetical case, a promotion for a hair care product was sent to some members of a buyers club. Purchases were then recorded for both the members who got the promotion and those who did not.</p>
<div id="cell-56" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(DATA <span class="op">/</span> <span class="st">'Hair-Care-Product.csv'</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>data.columns <span class="op">=</span> [d.replace(<span class="st">'.'</span>, <span class="st">'_'</span>).replace(<span class="st">' '</span>, <span class="st">'_'</span>).replace(<span class="st">'__'</span>, <span class="st">'_'</span>) <span class="cf">for</span> d <span class="kw">in</span> data.columns]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Purchase</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Hair_Color</th>
<th data-quarto-table-cell-role="th">U_S_Region</th>
<th data-quarto-table-cell-role="th">Validation</th>
<th data-quarto-table-cell-role="th">Promotion_ord</th>
<th data-quarto-table-cell-role="th">Gender_ord</th>
<th data-quarto-table-cell-role="th">Residence_ord</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>25</td>
<td>Black</td>
<td>Southwest</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>30</td>
<td>Black</td>
<td>Northwest</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>45</td>
<td>Red</td>
<td>Northeast</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>35</td>
<td>Blond</td>
<td>Southwest</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>33</td>
<td>Brown</td>
<td>Southwest</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="solution-13.4.a" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.4.a">Solution 13.4.a</h2>
<p>What is the purchase propensity ### 13.4.a.i among those who received the promotion? &gt; The purchase propensity among those who received the promotion = (Number of purchases made) / (Total Number of Records)</p>
<p>The <code>Promotion_ord</code> column has a 1 for members that received a promotion. The <code>Purchase</code> column has a 1 for members that purchased a product after the promotion. By multiplying the two columns we therefore get a 1 for all members that received a promotion and made a purchase and a 0 otherwise.</p>
<div id="cell-58" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of purchases made for members that got a promotion</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of purchases made"</span>, <span class="bu">sum</span>(data[<span class="st">'Purchase'</span>] <span class="op">*</span> data[<span class="st">'Promotion_ord'</span>]))</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of members that got a promotion</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total Number of Records"</span>, <span class="bu">sum</span>(data[<span class="st">'Promotion_ord'</span>]))</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Purchase propensity</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"80 / 4976 = "</span>, <span class="bu">sum</span>(data[<span class="st">'Purchase'</span>] <span class="op">*</span> data[<span class="st">'Promotion_ord'</span>]) <span class="op">/</span> <span class="bu">sum</span>(data[<span class="st">'Promotion_ord'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of purchases made 80
Total Number of Records 4976
80 / 4976 =  0.01607717041800643</code></pre>
</div>
</div>
<section id="a.ii" class="level3">
<h3 class="anchored" data-anchor-id="a.ii">13.4.a.ii</h3>
<p>among those who did not receive the promotion?</p>
<div id="cell-60" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of purchases made for members that got a promotion</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of purchases made"</span>, <span class="bu">sum</span>(data[<span class="st">'Purchase'</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> data[<span class="st">'Promotion_ord'</span>])))</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of members that got a promotion</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total Number of Records"</span>, <span class="bu">sum</span>(<span class="dv">1</span> <span class="op">-</span> data[<span class="st">'Promotion_ord'</span>]))</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Purchase propensity</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"32 / 5024 = "</span>, <span class="bu">sum</span>(data[<span class="st">'Purchase'</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> data[<span class="st">'Promotion_ord'</span>])) <span class="op">/</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="op">-</span> data[<span class="st">'Promotion_ord'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of purchases made 32
Total Number of Records 5024
32 / 5024 =  0.006369426751592357</code></pre>
</div>
</div>
</section>
</section>
<section id="solution-13.4.b" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.4.b">Solution 13.4.b</h2>
<p>Partition the data into training (60%) and validation (40%)</p>
<div id="cell-62" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>data.Hair_Color <span class="op">=</span> data.Hair_Color.astype(<span class="st">'category'</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>data.U_S_Region <span class="op">=</span> data.U_S_Region.astype(<span class="st">'category'</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.get_dummies(data, drop_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>data.head()</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co"># KNeighborsClassifier(n_neighbors=row.k).fit(trainNorm[['zIncome', 'zLot_Size']], trainNorm['Ownership'])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Purchase</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Validation</th>
<th data-quarto-table-cell-role="th">Promotion_ord</th>
<th data-quarto-table-cell-role="th">Gender_ord</th>
<th data-quarto-table-cell-role="th">Residence_ord</th>
<th data-quarto-table-cell-role="th">Hair_Color_Blond</th>
<th data-quarto-table-cell-role="th">Hair_Color_Brown</th>
<th data-quarto-table-cell-role="th">Hair_Color_Red</th>
<th data-quarto-table-cell-role="th">U_S_Region_Northwest</th>
<th data-quarto-table-cell-role="th">U_S_Region_Southeast</th>
<th data-quarto-table-cell-role="th">U_S_Region_Southwest</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>25</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>30</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>45</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>35</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>33</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-63" class="cell" data-scrolled="true" data-execution_count="34">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> data[<span class="st">'Purchase'</span>]</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> data.drop(columns<span class="op">=</span>[<span class="st">'Purchase'</span>])</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize the dataset</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> preprocessing.StandardScaler()</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>X_norm <span class="op">=</span> scaler.fit_transform(X <span class="op">*</span> <span class="fl">1.0</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>data_norm <span class="op">=</span> pd.concat([pd.DataFrame(X_norm, columns<span class="op">=</span>data.columns[<span class="dv">1</span>:]),</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>                       data[<span class="st">'Purchase'</span>]], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>train, valid <span class="op">=</span> train_test_split(data_norm, test_size<span class="op">=</span><span class="fl">0.4</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="solution-13.4.b.i" class="level3">
<h3 class="anchored" data-anchor-id="solution-13.4.b.i">Solution 13.4.b.i</h3>
<p>Uplift using a Random Forest.</p>
<div id="cell-65" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>rfModel <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>rfModel.fit(train.drop(columns<span class="op">=</span>[<span class="st">'Purchase'</span>]), train.Purchase)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> rfModel.predict(valid.drop(columns<span class="op">=</span>[<span class="st">'Purchase'</span>]))</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid.Purchase, pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (Accuracy 0.9840)

       Prediction
Actual    0    1
     0 3936   12
     1   52    0</code></pre>
</div>
</div>
<div id="cell-66" class="cell" data-scrolled="true" data-execution_count="36">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>uplift_df <span class="op">=</span> valid.drop(columns<span class="op">=</span>[<span class="st">'Purchase'</span>]).copy()  <span class="co"># Need to create a copy to allow modifying data</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>uplift_df.Promotion_ord <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>predTreatment <span class="op">=</span> rfModel.predict_proba(uplift_df)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>uplift_df.Promotion_ord <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>predControl <span class="op">=</span> rfModel.predict_proba(uplift_df)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>upliftResult_rf <span class="op">=</span> pd.DataFrame({</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'probMessage'</span>: predTreatment[:,<span class="dv">1</span>],</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'probNoMessage'</span>: predControl[:,<span class="dv">1</span>],</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'uplift'</span>: predTreatment[:,<span class="dv">1</span>] <span class="op">-</span> predControl[:,<span class="dv">1</span>],</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    }, index<span class="op">=</span>uplift_df.index)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>upliftResult_rf <span class="op">=</span> upliftResult_rf.sort_values(by<span class="op">=</span>[<span class="st">'uplift'</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>upliftResult_rf.reset_index().plot(x<span class="op">=</span><span class="va">None</span>, y<span class="op">=</span><span class="st">'uplift'</span>)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch-13-ProbSolutions-Ensemble_files/figure-html/cell-37-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="solution-13.4.b.ii" class="level3">
<h3 class="anchored" data-anchor-id="solution-13.4.b.ii">Solution 13.4.b.ii</h3>
<p>Uplift using <span class="math inline">\(k\)</span>-NN.</p>
<div id="cell-68" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>knnModel <span class="op">=</span> KNeighborsClassifier(n_neighbors<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>knnModel.fit(train.drop(columns<span class="op">=</span>[<span class="st">'Purchase'</span>]), train.Purchase)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> knnModel.predict(valid.drop(columns<span class="op">=</span>[<span class="st">'Purchase'</span>]))</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>classificationSummary(valid.Purchase, pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix (Accuracy 0.9870)

       Prediction
Actual    0    1
     0 3948    0
     1   52    0</code></pre>
</div>
</div>
<div id="cell-69" class="cell" data-scrolled="true" data-execution_count="38">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>uplift_df <span class="op">=</span> valid.drop(columns<span class="op">=</span>[<span class="st">'Purchase'</span>]).copy()  <span class="co"># Need to create a copy to allow modifying data</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>uplift_df.Promotion_ord <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>predTreatment <span class="op">=</span> knnModel.predict_proba(uplift_df)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>uplift_df.Promotion_ord <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>predControl <span class="op">=</span> knnModel.predict_proba(uplift_df)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>upliftResult_knn <span class="op">=</span> pd.DataFrame({</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'probMessage'</span>: predTreatment[:,<span class="dv">1</span>],</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'probNoMessage'</span>: predControl[:,<span class="dv">1</span>],</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'uplift'</span>: predTreatment[:,<span class="dv">1</span>] <span class="op">-</span> predControl[:,<span class="dv">1</span>],</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    }, index<span class="op">=</span>uplift_df.index)</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>upliftResult_knn <span class="op">=</span> upliftResult_knn.sort_values(by<span class="op">=</span>[<span class="st">'uplift'</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>upliftResult_knn.reset_index().plot(x<span class="op">=</span><span class="va">None</span>, y<span class="op">=</span><span class="st">'uplift'</span>)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch-13-ProbSolutions-Ensemble_files/figure-html/cell-39-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="solution-13.4.c" class="level2">
<h2 class="anchored" data-anchor-id="solution-13.4.c">Solution 13.4.c</h2>
<p>Report the two models’ recommendations for the first three members.</p>
<div id="cell-71" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>upliftResult_rf.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">probMessage</th>
<th data-quarto-table-cell-role="th">probNoMessage</th>
<th data-quarto-table-cell-role="th">uplift</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">6751</td>
<td>0.723333</td>
<td>0.01</td>
<td>0.713333</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">201</td>
<td>0.723333</td>
<td>0.01</td>
<td>0.713333</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3380</td>
<td>0.730000</td>
<td>0.04</td>
<td>0.690000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-72" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>upliftResult_knn.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">probMessage</th>
<th data-quarto-table-cell-role="th">probNoMessage</th>
<th data-quarto-table-cell-role="th">uplift</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">7317</td>
<td>0.181818</td>
<td>0.0</td>
<td>0.181818</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7451</td>
<td>0.181818</td>
<td>0.0</td>
<td>0.181818</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9520</td>
<td>0.181818</td>
<td>0.0</td>
<td>0.181818</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>